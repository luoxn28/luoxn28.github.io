<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="该来的终究会来，而且比想象的更快！"><title>influxdb入门 | luoxn28</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">influxdb入门</h1><a id="logo" href="/.">luoxn28</a><p class="description">南</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">influxdb入门</h1><div class="post-meta">Jan 28, 2020<script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#influxdb基础"><span class="toc-number">1.</span> <span class="toc-text">influxdb基础</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据读写"><span class="toc-number">2.</span> <span class="toc-text">数据读写</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据保留策略"><span class="toc-number">3.</span> <span class="toc-text">数据保留策略</span></a></li></ol></div></div><div class="post-content"><blockquote>
<p>InfluxDB是一个开源的时序数据库，使用GO语言开发，特别适合用于处理和分析资源监控数据这种时序相关数据。而InfluxDB自带的各种特殊函数如求标准差，随机取样数据，统计数据变化比等，使数据统计和实时分析变得十分方便。</p>
</blockquote>
<p>influxdb的单机版是开源的，而集群版是商业版，influxdb被设计运行在SSD上，如果使用机器或者网络磁盘作为存储介质，会导致性能下降至少一个数量级。influxdb支持restful api，同时也支持https，为了保证安全性，非局域网建议使用https与Influxdb进行通信。</p>
<h3 id="influxdb基础"><a href="#influxdb基础" class="headerlink" title="influxdb基础"></a>influxdb基础</h3><p>infludb中存储的是时间序列数据，比如说某个时间点系统负载、服务耗时等信息，时间序列数据可以包含多个值。关于什么是时间序列数据，简单来来说就是数据是和一个时间点关联的，结合mysql中的记录与id关系来看就是时间序列数据的主键就是时间点（<code>timestrap</code>）。</p>
<p>infludb中的一条数据至少包括<code>measurement</code>（对应mysql中表概念）、<code>timestamp</code>、至少<code>一个k-v结构的field</code>，再加上0个或者多个k-v结构的tag。对比mysql来看，measurement就是一张表，其主键是timestamp时间戳，tag和field对应就是表中列，tag和field都是k-v接口，k对应列的名字，v对应该列存储的值，tag和field不同的是，tag是有索引的而field没有（如果查询条件为tag则会扫描所有查询到的数据），对于mysql表的有索引列和无索引列。注意mysql中的表需要提前定义结构，而influxdb中的measurement无需提前定义，其null值也不会被存储。</p>
<p>influxdb中measurement无需定义，即无模式设计，开发者可以在任意添加measurement，tags和fields，不过针对同一个field，第二次和第一次写入的数据类型不匹配，influxdb会报错（由于默认tag的v都是字符串类型，所有不存在这个问题，不管输入是什么数据都当做字符串来处理）。</p>
<h3 id="数据读写"><a href="#数据读写" class="headerlink" title="数据读写"></a>数据读写</h3><p>influxdb数据写入需满足如下格式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> &lt;measurement&gt;[,&lt;tag-<span class="keyword">key</span>&gt;=&lt;tag-<span class="keyword">value</span>&gt;...] &lt;<span class="keyword">field</span>-<span class="keyword">key</span>&gt;=&lt;<span class="keyword">field</span>-<span class="keyword">value</span>&gt;[,&lt;field2-<span class="keyword">key</span>&gt;=&lt;field2-<span class="keyword">value</span>&gt;...] [unix-nano-<span class="built_in">timestamp</span>]</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：measurement和至少一个fileld的k-v是必须的，tag和timestrap时间戳是可选的。</p>
</blockquote>
<p>说实话，这个写入格式还是有点小严格的，因为它要求measurement和可能的0个或多个tag之间必须是紧挨着的，中间不能有空格；同时多个filed之间也是不能有空格，tag和field的k，tag的v都是字符串类型；时间戳不是必须的，如果为空则使用服务端的本地时间作为时间戳。相同时间戳的数据第二次写入会覆盖第一次写入的数据，相当于更新操作。</p>
<blockquote>
<p>为什么至少有一个filed是必须的，而tag是可选的呢？</p>
</blockquote>
<p>这是influxdb的存储模型决定的，<code>measurement+tag set+field key</code>作为key，field value作为value，如果没有field则没有了对应的value了。</p>
<blockquote>
<p>插入数据的tag key和field key能一样么？</p>
</blockquote>
<p>数据插入没问题，这是由于infludb底层存储tag和field是在不同地方的，只不过为了区分会加上<code>_序号</code>而已，如下图：</p>
<p><img src="/2020/01/28/influxdb-ru-men/./influxdb入门/image-20200128085046609.png" alt></p>
<p>当在use某个db之后，就可以执行数据读写操作，比如下面往名字为cpu的<code>MEASUREMENT（对应mysql中的表概念）</code>中写入如下数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> cpu,host=s01,region=hangzhou <span class="keyword">value</span>=<span class="number">0.64</span> <span class="number">1520052020000000000</span></span><br><span class="line">命令说明：</span><br><span class="line">- 插入数据对应的MEASUREMENT名字为cpu；</span><br><span class="line">- 数据tag分别是host和region，<span class="keyword">field</span>是<span class="keyword">value</span>；</span><br><span class="line">- 数据的最后一项是时间戳（<span class="number">1520052020000000000</span>），时间戳不是必须的，如果不传则使用influxdb服务端本地时间戳，注意时间戳都是UTC时间</span><br></pre></td></tr></table></figure>
<h3 id="数据保留策略"><a href="#数据保留策略" class="headerlink" title="数据保留策略"></a>数据保留策略</h3><p>Influxdb可支持每秒十万级别的数据量，如果长时间保存会对存储造成很大压力，因此和一般数据存储系统一样有一个数据保留策略，同时针对大流量量数据可采样保存，小流量数据可全量保存。influxdb通过保留策略（RP，Retention Policy）来管理过期数据，使用连续查询（<code>CR，Continuous Queries</code>）来进行数据采样。</p>
<ul>
<li>RP：数据保留策略，过期数据会被清除，每个数据库可拥有多种RP策略；</li>
<li>CQ：数据连续查询，定时跑的一个查询语句，比如周期性统计某个数据指标，查询语句需要在select语句中使用并且包含group by time子句（这里有点类似Flink中流数据处理的按时间窗口统计功能）。</li>
</ul>
<p>默认写数据不指定保留策略（RP，Retention Policy）时，默认使用influxdb默认的RP，名字叫做autogen的RP会永久保留数据。如果使用命令 <code>create retention policy &quot;default2&quot; on &quot;db2&quot; duration 2h replication 1 default</code>，执行该命令后default2会取代默认的autugen作为db2数据库的默认RP，默认influxdb会间隔半个小时执行一次RP操作。</p>
<blockquote>
<p>比如有一个服务请求日志measurement的名字为log（RP策略是2小时，数据库是db2），其中数据有服务耗时（字段对应名字time），我们想统计每分钟平均服务耗时，然后将平均耗时数据写入到名字为log2的measurement（RP策略是2天），该如何做呢？</p>
</blockquote>
<p>首先创建2小时和2天的RP策略：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">retention</span> <span class="keyword">policy</span> <span class="string">"tow_hour"</span> <span class="keyword">on</span> db2 <span class="keyword">duration</span> <span class="number">2</span>h <span class="keyword">replication</span> <span class="number">1</span></span><br><span class="line"><span class="comment"># 对数据库db2创建一个名字叫"tow_hour"的RP策略，数据保存2小时，由于最后没有加default，所以数据读写如果没有执行RP仍然使用的是influxdb默认的RP</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">retention</span> <span class="keyword">policy</span> <span class="string">"tow_day"</span> <span class="keyword">on</span> db2 <span class="keyword">duration</span> <span class="number">2</span>d <span class="keyword">replication</span> <span class="number">1</span></span><br><span class="line"><span class="comment"># 对数据库db2创建一个名字叫"tow_day"的RP策略，注意对于单机版influxdb来说replication无意义</span></span><br></pre></td></tr></table></figure>
<p>然后使用create continuous query创建CQ策略：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> continuous <span class="keyword">query</span> <span class="string">"cq_avg_time"</span> <span class="keyword">on</span> db2 </span><br><span class="line"><span class="keyword">begin</span> </span><br><span class="line">    <span class="keyword">select</span> mean(<span class="string">"time"</span>) <span class="keyword">as</span> <span class="string">"mean_time"</span> <span class="keyword">into</span> <span class="string">"tow_day"</span>.<span class="string">"log2"</span> <span class="keyword">from</span> <span class="keyword">log</span> </span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> <span class="built_in">time</span>(<span class="number">1</span>m) </span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>这样就创建了一个名字叫cq_avg_time的CQ作用于db2数据库，每1分钟一次计算measurement为log的time字段的平均值，然后写入到另一个measurement为log2中。</p>
</div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>luoxn28</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/2020/01/28/influxdb-ru-men/">http://luoxn28.github.io/2020/01/28/influxdb-ru-men/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本文章著作权归作者所有，任何形式的转载都请注明出处。</li></ul></div><br><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="http://luoxn28.github.io/2020/01/28/influxdb-ru-men/" data-id="ck8obhpsc001ac7ciyt1ffbq6" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACJUlEQVR42u3aSW7DMBAEQP//084HYql7aAURVTwZsRaWAwxm4esVr/fhOr7y+Gmfvn1dsTAwMG7LSLb4DtbxhhJ8ctfHN2JgYDyAkWzi+NHHd+UhdfgEDAwMjJi0krNhYGBgXM1INjFLKDEwMDDagDhrkCXtuT+qxTEwMG7IyLvuf//5kvkGBgbGrRjvciWhMx9V5unjya4wMDC2ZswSu3wYmY8z27QPAwPjmYy8NTY7nNEG3DxkY2BgPI2RBNO2cTYbf+b3YmBg7M3Ix42z7bapZDuQiGaeGBgYN2esH6pY+ctsLPrxLgwMjK0Z+SbyAjhvt+V7GFbkGBgYmzK+1dzPtzUbBvxyFwYGxnaMNlC2pCQotz/BSbsNAwNjO8YsdZu1yfKnJT9fUZFjYGDcnNGGwnb0OCtu2wMZGBgYezPywjIPfytHK9qhxcmZEQwMjC0YeQI3C7LtAY7hmBMDA2NrRr7dWRK5MpicvQsDA2NXxhVjy3Yw2Yb7k/8DBgbGYxjthCEPyiuAuneIgYGxESMfZ64fpJi1/qOuIQYGxgMYs9e0A8v8+jxkY2Bg7Mp4lysvL/MguzJm+MJWMDAw/j1jPdi1iWM7mJylpBgYGPsx2hb/FcG3DbgYGBjPZLTDxevC9LAMxsDAwCg/5w279mknFTkGBgZGMmcoy9eVa74QcDEwMG7FSIrYPERGL15IRjEwMJ7GyEvHGSlPFldSSQwMjE0ZP9jY0T+YO34rAAAAAElFTkSuQmCC">分享</a><div class="tags"><a href="/tags/influxdb/">influxdb</a></div><div class="post-nav"><a class="pre" href="/2020/02/08/kubernetes-zhi-pod-na-xie-shi/">kubernetes之Pod那些事</a><a class="next" href="/2020/01/28/influxdb-yuan-li-na-xie-shi/">influxdb原理那些事</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=0.0.0"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=0.0.0"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=0.0.0"></script><script>var gitalk = new Gitalk({
  clientID: '0eda0c4ea18dd9042b41',
  clientSecret: 'df032ab700b83adbcaaf2f74eee0004c1ada25df',
  repo: 'luoxn28.github.io.gittalk',
  owner: 'luoxn28',
  admin: ['luoxn28'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/分布式/">分布式</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/操作系统/">操作系统</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/框架研究/">框架研究</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/随笔/">随笔</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/多线程/" style="font-size: 15px;">多线程</a> <a href="/tags/netty/" style="font-size: 15px;">netty</a> <a href="/tags/redis/" style="font-size: 15px;">redis</a> <a href="/tags/influxdb/" style="font-size: 15px;">influxdb</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/sentinel/" style="font-size: 15px;">sentinel</a> <a href="/tags/线上问题/" style="font-size: 15px;">线上问题</a> <a href="/tags/dubbo/" style="font-size: 15px;">dubbo</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/03/31/ye-shi-nei-cun-guan-li/">页式内存管理</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/17/group-by-zhong-zi-cha-xun-order-by-pai-xu-shi-xiao-wen-ti-fen-xi/">group by中子查询order by排序失效问题分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/16/transmittable-thread-local-xian-cheng-jian-shang-xia-wen-chuan-di-jie-jue-fang-an/">Transmittable-Thread-Local：线程间上下文传递解决方案</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/13/xian-cheng-chi-ru-he-chuan-di-xian-cheng-shang-xia-wen-xin-xi/">线程池如何传递线程上下文信息</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/08/tostring-ru-he-fan-xu-lie-hua/">ToString如何反序列化</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/02/29/java-bing-fa-gong-ju-lei/">Java并发工具类</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/02/19/yi-qi-liao-liao-3-ge-xian-cheng-yi-ci-da-yin-1-2-3-de-gu-shi/">一起聊聊3个线程依次打印1、2、3的故事</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/02/08/kubernetes-zhi-pod-na-xie-shi/">kubernetes之Pod那些事</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/01/28/influxdb-ru-men/">influxdb入门</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/01/28/influxdb-yuan-li-na-xie-shi/">influxdb原理那些事</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">luoxn28.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>